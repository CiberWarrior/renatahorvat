---
// Cookie Consent Banner Component
// Displays on first visit and manages user cookie preferences
---

<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="hidden fixed bottom-0 left-0 right-0 z-[9999] p-4 md:p-6 bg-gray-900/95 backdrop-blur-xl border-t border-cyan-400/30 shadow-2xl">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
      <!-- Content -->
      <div class="flex-1">
        <div class="flex items-start gap-3 mb-3">
          <span class="text-3xl">üç™</span>
          <div>
            <h3 class="text-lg font-bold text-white mb-2">Cookie Consent</h3>
            <p class="text-gray-300 text-sm leading-relaxed max-w-3xl">
              We use cookies to enhance your browsing experience, analyze website traffic, and understand where our visitors are coming from. 
              By clicking "Accept All", you consent to our use of cookies. You can manage your preferences or learn more in our 
              <a href="/privacy-policy" class="text-cyan-400 hover:text-cyan-300 underline font-semibold">Privacy Policy</a>.
            </p>
          </div>
        </div>

        <!-- Cookie Details (Expandable) -->
        <div id="cookie-details" class="hidden ml-12 mt-4 space-y-3">
          <div class="p-3 bg-gray-800/50 border border-gray-700 rounded-lg">
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" checked disabled class="mt-1 w-4 h-4 rounded border-gray-600 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-gray-900">
              <div class="flex-1">
                <div class="font-semibold text-white text-sm">Essential Cookies (Required)</div>
                <div class="text-gray-400 text-xs mt-1">Necessary for the website to function properly. Cannot be disabled.</div>
              </div>
            </label>
          </div>

          <div class="p-3 bg-gray-800/50 border border-gray-700 rounded-lg">
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox" id="analytics-cookies" checked class="mt-1 w-4 h-4 rounded border-gray-600 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-gray-900">
              <div class="flex-1">
                <div class="font-semibold text-white text-sm">Analytics Cookies</div>
                <div class="text-gray-400 text-xs mt-1">
                  Help us understand how visitors interact with our website (Google Analytics).
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
        <button 
          id="cookie-settings-btn"
          class="px-4 py-2 border-2 border-gray-600 text-gray-300 font-semibold rounded-xl hover:bg-gray-800 hover:border-gray-500 transition-all duration-300 text-sm whitespace-nowrap"
        >
          Customize
        </button>
        <button 
          id="cookie-reject-btn"
          class="px-4 py-2 border-2 border-gray-600 text-gray-300 font-semibold rounded-xl hover:bg-gray-800 hover:border-gray-500 transition-all duration-300 text-sm whitespace-nowrap"
        >
          Reject All
        </button>
        <button 
          id="cookie-accept-btn"
          class="px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold rounded-xl hover:from-cyan-600 hover:to-blue-700 transition-all duration-300 text-sm whitespace-nowrap"
        >
          Accept All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cookie Settings Button (Fixed) - Shows after consent given -->
<button 
  id="cookie-settings-trigger" 
  class="hidden fixed bottom-4 left-4 z-[9998] p-3 bg-gray-900/90 backdrop-blur-sm border border-cyan-400/30 rounded-full shadow-lg hover:scale-110 transition-all duration-300 group"
  title="Cookie Settings"
>
  <svg class="w-6 h-6 text-cyan-400 group-hover:text-cyan-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
  </svg>
</button>

<script>
  // Cookie Consent Management
  const COOKIE_CONSENT_KEY = 'cookie-consent';
  const COOKIE_CONSENT_VERSION = '1.0';

  interface CookieConsent {
    version: string;
    timestamp: number;
    analytics: boolean;
  }

  // Check if consent is already given
  function hasConsent(): CookieConsent | null {
    const consent = localStorage.getItem(COOKIE_CONSENT_KEY);
    if (!consent) return null;
    
    try {
      const parsed = JSON.parse(consent) as CookieConsent;
      // Check if version matches
      if (parsed.version !== COOKIE_CONSENT_VERSION) {
        return null;
      }
      return parsed;
    } catch {
      return null;
    }
  }

  // Save consent
  function saveConsent(analytics: boolean) {
    const consent: CookieConsent = {
      version: COOKIE_CONSENT_VERSION,
      timestamp: Date.now(),
      analytics: analytics,
    };
    localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(consent));
  }

  // Load Google Analytics
  function loadAnalytics() {
    // Analytics is already loaded in Layout.astro
    // This function is called to confirm it should be active
    if (typeof window.gtag !== 'undefined') {
      window.gtag('consent', 'update', {
        'analytics_storage': 'granted'
      });
    }
  }

  // Disable Google Analytics
  function disableAnalytics() {
    if (typeof window.gtag !== 'undefined') {
      window.gtag('consent', 'update', {
        'analytics_storage': 'denied'
      });
    }
    
    // Set GA disable flag
    window['ga-disable-G-CY6VB6BVJL'] = true;
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    const banner = document.getElementById('cookie-consent-banner');
    const settingsTrigger = document.getElementById('cookie-settings-trigger');
    const acceptBtn = document.getElementById('cookie-accept-btn');
    const rejectBtn = document.getElementById('cookie-reject-btn');
    const settingsBtn = document.getElementById('cookie-settings-btn');
    const cookieDetails = document.getElementById('cookie-details');
    const analyticsCheckbox = document.getElementById('analytics-cookies') as HTMLInputElement;

    if (!banner || !settingsTrigger || !acceptBtn || !rejectBtn || !settingsBtn) {
      return;
    }

    // Check existing consent
    const consent = hasConsent();
    
    if (consent) {
      // Consent already given
      if (consent.analytics) {
        loadAnalytics();
      } else {
        disableAnalytics();
      }
      // Show settings trigger button
      settingsTrigger.classList.remove('hidden');
    } else {
      // No consent yet - show banner
      banner.classList.remove('hidden');
      // Disable analytics by default until consent
      disableAnalytics();
    }

    // Accept All
    acceptBtn.addEventListener('click', function() {
      saveConsent(true);
      loadAnalytics();
      banner.classList.add('hidden');
      settingsTrigger.classList.remove('hidden');
      
      // Track consent given
      if (typeof window.gtag !== 'undefined') {
        window.gtag('event', 'cookie_consent', {
          consent_action: 'accept_all'
        });
      }
    });

    // Reject All
    rejectBtn.addEventListener('click', function() {
      saveConsent(false);
      disableAnalytics();
      banner.classList.add('hidden');
      settingsTrigger.classList.remove('hidden');
      
      // Track consent rejected (won't actually fire since analytics disabled)
      console.log('Cookie consent: rejected');
    });

    // Customize - Toggle details
    settingsBtn.addEventListener('click', function() {
      if (cookieDetails) {
        cookieDetails.classList.toggle('hidden');
        settingsBtn.textContent = cookieDetails.classList.contains('hidden') ? 'Customize' : 'Save Settings';
        
        // If saving
        if (cookieDetails.classList.contains('hidden')) {
          const analyticsEnabled = analyticsCheckbox?.checked || false;
          saveConsent(analyticsEnabled);
          
          if (analyticsEnabled) {
            loadAnalytics();
          } else {
            disableAnalytics();
          }
          
          banner.classList.add('hidden');
          settingsTrigger.classList.remove('hidden');
          
          // Track custom settings
          if (typeof window.gtag !== 'undefined' && analyticsEnabled) {
            window.gtag('event', 'cookie_consent', {
              consent_action: 'customize',
              analytics_enabled: analyticsEnabled
            });
          }
        }
      }
    });

    // Settings trigger - reopen banner
    settingsTrigger.addEventListener('click', function() {
      banner.classList.remove('hidden');
      settingsTrigger.classList.add('hidden');
      
      // Load current preferences
      const currentConsent = hasConsent();
      if (currentConsent && analyticsCheckbox) {
        analyticsCheckbox.checked = currentConsent.analytics;
      }
    });
  });
</script>

<style>
  /* Smooth animations */
  #cookie-consent-banner {
    animation: slideUp 0.5s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  #cookie-settings-trigger {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Ensure banner is above everything */
  #cookie-consent-banner {
    will-change: transform;
  }
</style>
